import Time from "../ifr-core/Time.js";
import FileTools from "../ifr-core/FileTools.js";

const MotionLog = {};

/**
 * @param {string} filename
 * @return {Function}
 */
MotionLog.createLog = function(filename)
{
	if (typeof window !== 'undefined') {
		return function() {};
	}
	const fs = require("fs");
	const motionStream = fs.createWriteStream(filename);
	let first = true;
	return function(info)
	{
		if (first)
		{
			first = false;
		}
		else
		{
			motionStream.write(",\n");
		}
		motionStream.write(JSON.stringify(info));
	};
};

/**
 * Simple strategy to get data from browser without any saving; we'll log to the console with a unique prefix
 * to later be manually saved to file and loaded with loadConsoleLog
 *
 * @param {string} prefix
 * @return {Function}
 */
MotionLog.createConsoleLog = function(prefix)
{
	return function(info)
	{
		console.log(prefix+JSON.stringify(info));
	};
};

/**
 * @param {string} filename
 * @param {Function} cb
 */
MotionLog.loadLog = function(filename, cb)
{
	FileTools.loadText(filename, function(error, data)
	{
		if (error)
		{
			cb(error, null);
		}
		else
		{
			let infoArray = null;
			try
			{
				const infoString = "["+data+"]";
				infoArray = JSON.parse(infoString);
				for (let i=0; i<infoArray.length; i++)
				{
					infoArray[i].timestamp = Time.createFromTimestamp(infoArray[i].timestamp._timestamp);
				}
			}
			catch (e)
			{
				cb(e, null);
			}

			cb(null, infoArray);
		}
	});
};

/**
 * Reads in a file saved from the a console log generated by createConsoleLog
 * @param {string} filename
 * @param {string} prefix
 * @param {Function} cb
 */
MotionLog.loadConsoleLog = function(filename, prefix, cb)
{
	FileTools.loadText(filename, function(error, data)
	{
		if (error)
		{
			cb(error, null);
		}
		else
		{
			const infoArray = [];
			try
			{
				/** @type {string[]} */
				const lines = data.split("\n");
				for(let l = 0; l < lines.length; l++){
					const index = lines[l].indexOf(prefix);
					if(index >= 0){
						infoArray.push(JSON.parse(lines[l].substring(index+prefix.length)));
					}
				}
				for (let i=0; i<infoArray.length; i++)
				{
					infoArray[i].timestamp = Time.createFromTimestamp(infoArray[i].timestamp._timestamp);
				}
			}
			catch (e)
			{
				cb(e, null);
			}

			cb(null, infoArray);
		}
	});
};

export default MotionLog;
