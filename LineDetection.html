<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Line Detection</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        #outputImage { max-width: 100%; height: auto; border: 1px solid #ddd; }
        #controls { margin: 20px 0; }
        #ipInput { padding: 5px; width: 200px; }
        button { padding: 5px 10px; cursor: pointer; }
    </style>
    <script>
        const port = { camera: 8000 };
        const endpoint = { video: 'video_feed' };

        let collectLine = false;

        class LineDetector {
            constructor(raspberryPiIp, width = 640, height = 480) {
                this.raspberryPiIp = raspberryPiIp;
                this.width = width;
                this.height = height;
                this.canvas = document.createElement('canvas');
                this.canvas.width = width;
                this.canvas.height = height;
                this.ctx = this.canvas.getContext('2d');
                this.lastDetectedLine = [];
                this.frameCount = 0;
                this.allCoordinates = [];
            }

            async detectLine() {
                try {
                    const image = await this.loadImage(`http://${this.raspberryPiIp}:${port.camera}/${endpoint.video}`);
                    this.ctx.drawImage(image, 0, 0, this.width, this.height);
                    const imageData = this.ctx.getImageData(0, 0, this.width, this.height);
                    const lineCoordinates = this.processImageData(imageData);
                    console.log("coordinates");
                    console.log(lineCoordinates);
                    if (lineCoordinates.length > 0) {
                        this.lastDetectedLine = lineCoordinates;
                    }

                    if (collectLine) {
                        this.allCoordinates.push(lineCoordinates);
                        this.frameCount++;
                        this.writeCoordinatesToFile(this.allCoordinates);
                        collectLine = false;
                    }

                    this.drawLine(this.lastDetectedLine);
                    return this.canvas.toDataURL();
                } catch (error) {
                    console.error('Error detecting line:', error);
                    return null;
                }
            }

            loadImage(src) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.crossOrigin = "Anonymous";
                    img.onload = () => resolve(img);
                    img.onerror = reject;
                    img.src = src;
                });
            }

            processImageData(imageData) {
                const lineCoordinates = [];
                const threshold = 70;

                for (let y = 0; y < this.height; y++) {
                    for (let x = 0; x < this.width; x++) {
                        const index = (y * this.width + x) * 4;
                        const [r, g, b] = imageData.data.slice(index, index + 3);
                        
                        if (r < threshold && g < threshold && b < threshold && y < 400) {
                            lineCoordinates.push([x, y]);
                        }   
                    }
                }
                return lineCoordinates.sort((a, b) => a[1] - b[1]);
            }

            drawLine(coordinates) {
                this.ctx.beginPath();
                this.ctx.strokeStyle = 'blue';
                this.ctx.lineWidth = 2;
                coordinates.forEach(([x, y], i) => {
                this.ctx.arc(x, y, 5, 0, Math.PI*2);
                });
                this.ctx.stroke();
            }

            writeCoordinatesToFile(allCoordinates) {
                const content = allCoordinates.map((frame, index) => 
                    `export const baseLine = [${frame.map(coord => ("[" + coord.join(',') + "]"))}]\n`
                );
                const blob = new Blob([content], { type: 'text/plain' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'iterations.txt';
                a.click();
                URL.revokeObjectURL(a.href);
            }
        }

        let detector;
        let updateInterval;

        function initializeDetector() {
            const raspberryPiIp = document.getElementById('ipInput').value;
            if (!raspberryPiIp) {
                alert('Please enter a valid IP address');
                return;
            }
            detector = new LineDetector(raspberryPiIp);
            clearInterval(updateInterval);
            updateImage();
            updateInterval = setInterval(updateImage, 500);
        }

        function collectLineFn() {
            collectLine = true;
        }

        async function updateImage() {
            if (detector) {
                const imageDataUrl = await detector.detectLine();
                if (imageDataUrl) {
                    document.getElementById('outputImage').src = imageDataUrl;
                }
            }
        }
    </script>
</head>
<body>
    <h1>Line Detection</h1>
    <div id="controls">
        <input type="text" id="ipInput" placeholder="IP Address">
        <button onclick="initializeDetector()">Start Detection</button>
        <button onclick="collectLineFn()">Collect Points</button>
    </div>
    <img id="outputImage" alt="Processed Image">
</body>
</html>
