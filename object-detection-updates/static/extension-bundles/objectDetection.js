var objectDetection=function(e,t){"use strict";function o(e,t,o,a,i,n){function s(e){if(void 0!==e&&"function"!=typeof e)throw new TypeError("Function expected");return e}for(var r,c=a.kind,l="getter"===c?"get":"setter"===c?"set":"value",d=e?a.static?e:e.prototype:null,u=d?Object.getOwnPropertyDescriptor(d,a.name):{},h=!1,g=o.length-1;g>=0;g--){var v={};for(var p in a)v[p]="access"===p?{}:a[p];for(var p in a.access)v.access[p]=a.access[p];v.addInitializer=function(e){if(h)throw new TypeError("Cannot add initializers after decoration has completed");n.push(s(e||null))};var m=(0,o[g])("accessor"===c?{get:u.get,set:u.set}:u[l],v);if("accessor"===c){if(void 0===m)continue;if(null===m||"object"!=typeof m)throw new TypeError("Object expected");(r=s(m.get))&&(u.get=r),(r=s(m.set))&&(u.set=r),(r=s(m.init))&&i.unshift(r)}else(r=s(m))&&("field"===c?i.unshift(r):u[l]=r)}d&&Object.defineProperty(d,a.name,u),h=!0}function a(e,t,o,a){return new(o||(o=Promise))((function(i,n){function s(e){try{c(a.next(e))}catch(e){n(e)}}function r(e){try{c(a.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,r)}c((a=a.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;const i={name:"Object Detection",description:"Detects and identifies the object shown!",iconURL:"Typescript_logo.png",insetIconURL:"typescript-logo.svg",tags:["PRG Internal"]};let n=(()=>{var e;let n,s,r,c,l,d,u,h,g,v,p,m,b,x=t.extension(i,"video","drawable","addCostumes","toggleVideoBlock","setTransparencyBlock"),f=[];return e=class extends x{constructor(){super(...arguments),this.detector=function(e,t,o){for(var a=arguments.length>2,i=0;i<t.length;i++)o=a?t[i].call(e,o):t[i].call(e);return a?o:void 0}(this,f),this.DIMENSIONS=[480,360],this.drawables=[],this.cocoCategories=[{text:"person",value:"person"},{text:"bicycle",value:"bicycle"},{text:"car",value:"car"},{text:"motorcycle",value:"motorcycle"},{text:"airplane",value:"airplane"},{text:"bus",value:"bus"},{text:"train",value:"train"},{text:"truck",value:"truck"},{text:"boat",value:"boat"},{text:"traffic light",value:"traffic light"},{text:"fire hydrant",value:"fire hydrant"},{text:"stop sign",value:"stop sign"},{text:"parking meter",value:"parking meter"},{text:"bench",value:"bench"},{text:"bird",value:"bird"},{text:"cat",value:"cat"},{text:"dog",value:"dog"},{text:"horse",value:"horse"},{text:"sheep",value:"sheep"},{text:"cow",value:"cow"},{text:"elephant",value:"elephant"},{text:"bear",value:"bear"},{text:"zebra",value:"zebra"},{text:"giraffe",value:"giraffe"},{text:"backpack",value:"backpack"},{text:"umbrella",value:"umbrella"},{text:"handbag",value:"handbag"},{text:"tie",value:"tie"},{text:"suitcase",value:"suitcase"},{text:"frisbee",value:"frisbee"},{text:"skis",value:"skis"},{text:"snowboard",value:"snowboard"},{text:"sports ball",value:"sports ball"},{text:"kite",value:"kite"},{text:"baseball bat",value:"baseball bat"},{text:"baseball glove",value:"baseball glove"},{text:"skateboard",value:"skateboard"},{text:"surfboard",value:"surfboard"},{text:"tennis racket",value:"tennis racket"},{text:"bottle",value:"bottle"},{text:"wine glass",value:"wine glass"},{text:"cup",value:"cup"},{text:"fork",value:"fork"},{text:"knife",value:"knife"},{text:"spoon",value:"spoon"},{text:"bowl",value:"bowl"},{text:"banana",value:"banana"},{text:"apple",value:"apple"},{text:"sandwich",value:"sandwich"},{text:"orange",value:"orange"},{text:"broccoli",value:"broccoli"},{text:"carrot",value:"carrot"},{text:"hot dog",value:"hot dog"},{text:"pizza",value:"pizza"},{text:"donut",value:"donut"},{text:"cake",value:"cake"},{text:"chair",value:"chair"},{text:"couch",value:"couch"},{text:"potted plant",value:"potted plant"},{text:"bed",value:"bed"},{text:"dining table",value:"dining table"},{text:"toilet",value:"toilet"},{text:"TV",value:"TV"},{text:"laptop",value:"laptop"},{text:"mouse",value:"mouse"},{text:"remote",value:"remote"},{text:"keyboard",value:"keyboard"},{text:"cell phone",value:"cell phone"},{text:"microwave",value:"microwave"},{text:"oven",value:"oven"},{text:"toaster",value:"toaster"},{text:"sink",value:"sink"},{text:"refrigerator",value:"refrigerator"},{text:"book",value:"book"},{text:"clock",value:"clock"},{text:"vase",value:"vase"},{text:"scissors",value:"scissors"},{text:"teddy bear",value:"teddy bear"},{text:"hair drier",value:"hair drier"},{text:"toothbrush",value:"toothbrush"}]}init(){return a(this,void 0,void 0,(function*(){this.enableVideo(),this.continuous=!1,this.detector=yield a(void 0,void 0,void 0,(function*(){const{ObjectDetector:e,FilesetResolver:t}=yield import("https://cdn.skypack.dev/@mediapipe/tasks-vision@0.1.0-alpha-11"),o=yield t.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.1.0-alpha-11/wasm");return yield e.createFromOptions(o,{baseOptions:{modelAssetPath:"https://storage.googleapis.com/mediapipe-tasks/object_detector/efficientdet_lite0_uint8.tflite"},scoreThreshold:.5,runningMode:"IMAGE"})})),this.imageHelper=((e,t)=>{const o=document.body.appendChild(document.createElement("canvas"));o.hidden=!0,o.width=e,o.height=t;const a=o.getContext("2d");return{createRects(o,i,n){a.save(),a.clearRect(0,0,e,t),a.fillStyle=i;for(let e of o){const t=e.boundingBox.originX,o=e.boundingBox.originY,i=e.boundingBox.width,s=e.boundingBox.height;a.fillRect(t,o,i,s),a.clearRect(t+n,o+n,i-2*n,s-2*n);const r=e.categories[0].categoryName+" - with "+Math.round(100*parseFloat(e.categories[0].score))+"% confidence.";a.fillText(r,t,o-5)}return a.restore(),a.getImageData(0,0,e,t)}}})(this.DIMENSIONS[0],this.DIMENSIONS[1]),this.color="white",this.thickness=5,this.processFreq=100}))}detectionLoop(){return a(this,void 0,void 0,(function*(){for(;this.continuous;){const e=this.getVideoFrame("canvas"),o=Date.now();if(e){const t=yield this.detector.detect(e);this.displayImageDetections(t)}const a=Date.now()-o;yield t.untilTimePassed(this.processFreq-a),this.clearFrame()}}))}clearFrame(){for(;this.drawables.length>0;)this.drawables.shift().destroy()}displayImageDetections(e){return a(this,void 0,void 0,(function*(){const{drawables:t,imageHelper:o}=this,a=o.createRects(e.detections,this.color,this.thickness);t.push(this.createDrawable(a))}))}setFrameRate(e){this.processFreq=1e3/e}setColor(e){this.color=t.rgbToHex(e)}setThickness(e){this.thickness=e}detectObject(e){return a(this,void 0,void 0,(function*(){const o=this.getVideoFrame("canvas"),a=yield this.detector.detect(o);console.log("DETECTIONS"),console.log(a),this.displayImageDetections(a),yield t.untilTimePassed(1e3*e),this.clearFrame()}))}getObjectPosition(e,t){return a(this,void 0,void 0,(function*(){const o=this.getVideoFrame("canvas"),a=yield this.detector.detect(o);return 0==a.detections.length?0:"x"==e?a.detections[t].boundingBox.originX:"y"==e?a.detections[t].boundingBox.originY:"width"==e?a.detections[t].boundingBox.width:a.detections[t].boundingBox.height}))}inBounds(e){return a(this,void 0,void 0,(function*(){const t=this.getVideoFrame("canvas"),o=yield this.detector.detect(t);if(0==o.detections.length)return!1;for(let t=0;t<o.detections.length;t++)if(o.detections[t].categories.map((e=>e.categoryName)).includes(e))return!0;return!1}))}calculateDistance2D(e,t,o,a){return Math.sqrt(Math.pow(o-e,2)+Math.pow(a-t,2))}calculateAngle(e,t,o,a){let i=Math.atan2(a-t,o-e)*(180/Math.PI);return i=(i+360)%360,i}distanceToCategory(e,t,o){return a(this,void 0,void 0,(function*(){const a=this.getVideoFrame("canvas"),i=yield this.detector.detect(a);if(0==i.detections.length)return!1;let n;for(let t=0;t<i.detections.length;t++)i.detections[t].categories.map((e=>e.categoryName)).includes(e)&&(n=i.detections[t].boundingBox);if(n){let e=n.originX+n.width/2,a=n.originY+n.height/2;return this.calculateDistance2D(e,a,t,o)}return!1}))}distanceBetweenCategory(e,t){return a(this,void 0,void 0,(function*(){const o=this.getVideoFrame("canvas"),a=yield this.detector.detect(o);if(0==a.detections.length)return!1;let i,n;for(let o=0;o<a.detections.length;o++)a.detections[o].categories.map((e=>e.categoryName)).includes(e)&&(i=a.detections[o].boundingBox),a.detections[o].categories.map((e=>e.categoryName)).includes(t)&&(n=a.detections[o].boundingBox);if(i&&n){let e=i.originX+i.width/2,t=i.originY+i.height/2,o=n.originX+n.width/2,a=n.originY+n.height/2;return this.calculateDistance2D(e,t,o,a)}return!1}))}angleBetweenCategory(e,t){return a(this,void 0,void 0,(function*(){const o=this.getVideoFrame("canvas"),a=yield this.detector.detect(o);if(0==a.detections.length)return!1;let i,n;for(let o=0;o<a.detections.length;o++)a.detections[o].categories.map((e=>e.categoryName)).includes(e)&&(i=a.detections[o].boundingBox),a.detections[o].categories.map((e=>e.categoryName)).includes(t)&&(n=a.detections[o].boundingBox);if(i&&n){let e=i.originX+i.width/2,t=i.originY+i.height/2,o=n.originX+n.width/2,a=n.originY+n.height/2;return this.calculateAngle(e,t,o,a)}return!1}))}angleToCategory(e,t,o){return a(this,void 0,void 0,(function*(){const a=this.getVideoFrame("canvas"),i=yield this.detector.detect(a);if(0==i.detections.length)return!1;let n;for(let t=0;t<i.detections.length;t++)i.detections[t].categories.map((e=>e.categoryName)).includes(e)&&(n=i.detections[t].boundingBox);if(n){let e=n.originX+n.width/2,a=n.originY+n.height/2;return this.calculateAngle(e,a,t,o)}return!1}))}distanceToIndex(e,t,o){return a(this,void 0,void 0,(function*(){const a=this.getVideoFrame("canvas"),i=yield this.detector.detect(a);if(e<i.detections.length){let a=i.detections[e].boundingBox,n=a.originX+a.width/2,s=a.originY+a.height/2;return this.calculateDistance2D(n,s,t,o)}return!1}))}angleToIndex(e,t,o){return a(this,void 0,void 0,(function*(){const a=this.getVideoFrame("canvas"),i=yield this.detector.detect(a);if(e<i.detections.length){let a=i.detections[e].boundingBox,n=a.originX+a.width/2,s=a.originY+a.height/2;return this.calculateAngle(n,s,t,o)}return!1}))}continuouslyDetectObjects(e){return a(this,void 0,void 0,(function*(){this.continuous=e,this.detectionLoop()}))}},(()=>{var a;const i="function"==typeof Symbol&&Symbol.metadata?Object.create(null!==(a=x[Symbol.metadata])&&void 0!==a?a:null):void 0;n=[t.block({type:"command",text:e=>`Set detection rate to ${e}`,arg:{type:"number",options:[60,30,10,2,1],defaultValue:10}})],s=[t.block({type:"command",text:e=>`Set box color to ${e}`,arg:"color"})],r=[t.block({type:"command",text:e=>`Set box thickness to ${e}`,arg:{type:"number",defaultValue:5}})],c=[t.block({type:t.BlockType.Command,text:e=>`Detect objects for ${e} seconds`,arg:{type:t.ArgumentType.Number,defaultValue:1}})],l=[t.block({type:t.BlockType.Reporter,text:(e,t)=>`Get bounding box ${e} for box ${t}`,args:[{type:t.ArgumentType.String,options:[{text:"x",value:"x"},{text:"y",value:"y"},{text:"width",value:"width"},{text:"height",value:"height"}],defaultValue:"x"},{type:t.ArgumentType.Number,defaultValue:0}]})],d=[t.scratch.reporter(((e,t)=>t`Is ${{type:"string",options:e.cocoCategories,defaultValue:"person"}} in bounds?`))],u=[t.scratch.reporter(((e,t)=>t`Distance from ${{type:"string",options:e.cocoCategories,defaultValue:"person"}} to x ${"number"}, y ${"number"}`))],h=[t.scratch.reporter(((e,t)=>t`Distance from ${{type:"string",options:e.cocoCategories,defaultValue:"person"}} to ${{type:"string",options:e.cocoCategories,defaultValue:"person"}}`))],g=[t.scratch.reporter(((e,t)=>t`Angle from ${{type:"string",options:e.cocoCategories,defaultValue:"person"}} to ${{type:"string",options:e.cocoCategories,defaultValue:"person"}}`))],v=[t.scratch.reporter(((e,t)=>t`Angle from ${{type:"string",options:e.cocoCategories,defaultValue:"person"}} to x ${"number"}, y ${"number"}`))],p=[t.scratch.reporter`Distance from box ${"number"} to x ${"number"}, y ${"number"}`],m=[t.scratch.reporter`Angle from box ${"number"} to x ${"number"}, y ${"number"}`],b=[t.block({type:t.BlockType.Command,text:e=>`Toggle continuous detection ${e}`,arg:{type:t.ArgumentType.Boolean,options:[{text:"on",value:!0},{text:"off",value:!1}]}})],o(e,0,n,{kind:"method",name:"setFrameRate",static:!1,private:!1,access:{has:e=>"setFrameRate"in e,get:e=>e.setFrameRate},metadata:i},null,f),o(e,0,s,{kind:"method",name:"setColor",static:!1,private:!1,access:{has:e=>"setColor"in e,get:e=>e.setColor},metadata:i},null,f),o(e,0,r,{kind:"method",name:"setThickness",static:!1,private:!1,access:{has:e=>"setThickness"in e,get:e=>e.setThickness},metadata:i},null,f),o(e,0,c,{kind:"method",name:"detectObject",static:!1,private:!1,access:{has:e=>"detectObject"in e,get:e=>e.detectObject},metadata:i},null,f),o(e,0,l,{kind:"method",name:"getObjectPosition",static:!1,private:!1,access:{has:e=>"getObjectPosition"in e,get:e=>e.getObjectPosition},metadata:i},null,f),o(e,0,d,{kind:"method",name:"inBounds",static:!1,private:!1,access:{has:e=>"inBounds"in e,get:e=>e.inBounds},metadata:i},null,f),o(e,0,u,{kind:"method",name:"distanceToCategory",static:!1,private:!1,access:{has:e=>"distanceToCategory"in e,get:e=>e.distanceToCategory},metadata:i},null,f),o(e,0,h,{kind:"method",name:"distanceBetweenCategory",static:!1,private:!1,access:{has:e=>"distanceBetweenCategory"in e,get:e=>e.distanceBetweenCategory},metadata:i},null,f),o(e,0,g,{kind:"method",name:"angleBetweenCategory",static:!1,private:!1,access:{has:e=>"angleBetweenCategory"in e,get:e=>e.angleBetweenCategory},metadata:i},null,f),o(e,0,v,{kind:"method",name:"angleToCategory",static:!1,private:!1,access:{has:e=>"angleToCategory"in e,get:e=>e.angleToCategory},metadata:i},null,f),o(e,0,p,{kind:"method",name:"distanceToIndex",static:!1,private:!1,access:{has:e=>"distanceToIndex"in e,get:e=>e.distanceToIndex},metadata:i},null,f),o(e,0,m,{kind:"method",name:"angleToIndex",static:!1,private:!1,access:{has:e=>"angleToIndex"in e,get:e=>e.angleToIndex},metadata:i},null,f),o(e,0,b,{kind:"method",name:"continuouslyDetectObjects",static:!1,private:!1,access:{has:e=>"continuouslyDetectObjects"in e,get:e=>e.continuouslyDetectObjects},metadata:i},null,f),i&&Object.defineProperty(e,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:i})})(),e})();return e.Extension=n,e}({},ExtensionFramework);//# sourceMappingURL=objectDetection.js.map
