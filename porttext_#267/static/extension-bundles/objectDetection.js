var objectDetection=function(e,t){"use strict";function o(e,t,o,i,n,s){function a(e){if(void 0!==e&&"function"!=typeof e)throw new TypeError("Function expected");return e}for(var c,r=i.kind,l="getter"===r?"get":"setter"===r?"set":"value",d=!t&&e?i.static?e:e.prototype:null,u=t||(d?Object.getOwnPropertyDescriptor(d,i.name):{}),h=!1,p=o.length-1;p>=0;p--){var m={};for(var f in i)m[f]="access"===f?{}:i[f];for(var f in i.access)m.access[f]=i.access[f];m.addInitializer=function(e){if(h)throw new TypeError("Cannot add initializers after decoration has completed");s.push(a(e||null))};var g=(0,o[p])("accessor"===r?{get:u.get,set:u.set}:u[l],m);if("accessor"===r){if(void 0===g)continue;if(null===g||"object"!=typeof g)throw new TypeError("Object expected");(c=a(g.get))&&(u.get=c),(c=a(g.set))&&(u.set=c),(c=a(g.init))&&n.unshift(c)}else(c=a(g))&&("field"===r?n.unshift(c):u[l]=c)}d&&Object.defineProperty(d,i.name,u),h=!0}function i(e,t,o,i){return new(o||(o=Promise))((function(n,s){function a(e){try{r(i.next(e))}catch(e){s(e)}}function c(e){try{r(i.throw(e))}catch(e){s(e)}}function r(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,c)}r((i=i.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;const n={name:"Object Detection",description:"Detects and identifies the object shown!",iconURL:"Typescript_logo.png",insetIconURL:"typescript-logo.svg"};let s=(()=>{var e;let s,a,c,r,l,d=t.extension(n,"video","drawable","addCostumes","toggleVideoBlock","setTransparencyBlock"),u=[];return e=class extends d{constructor(){super(...arguments),this.detector=void function(e,t,o){for(var i=arguments.length>2,n=0;n<t.length;n++)o=i?t[n].call(e,o):t[n].call(e)}(this,u),this.DIMENSIONS=[480,360],this.drawables=[]}init(){return i(this,void 0,void 0,(function*(){this.enableVideo(),this.continuous=!1,this.detector=yield i(void 0,void 0,void 0,(function*(){const{ObjectDetector:e,FilesetResolver:t}=yield import("https://cdn.skypack.dev/@mediapipe/tasks-vision@0.1.0-alpha-11"),o=yield t.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.1.0-alpha-11/wasm");return yield e.createFromOptions(o,{baseOptions:{modelAssetPath:"https://storage.googleapis.com/mediapipe-tasks/object_detector/efficientdet_lite0_uint8.tflite"},scoreThreshold:.5,runningMode:"IMAGE"})})),this.imageHelper=((e,t)=>{const o=document.body.appendChild(document.createElement("canvas"));o.hidden=!0,o.width=e,o.height=t;const i=o.getContext("2d");return{createRects(o,n,s){i.save(),i.clearRect(0,0,e,t),i.fillStyle=n;for(let e of o){const t=e.boundingBox.originX,o=e.boundingBox.originY,n=e.boundingBox.width,a=e.boundingBox.height;i.fillRect(t,o,n,a),i.clearRect(t+s,o+s,n-2*s,a-2*s);const c=e.categories[0].categoryName+" - with "+Math.round(100*parseFloat(e.categories[0].score))+"% confidence.";i.fillText(c,t,o-5)}return i.restore(),i.getImageData(0,0,e,t)}}})(this.DIMENSIONS[0],this.DIMENSIONS[1]),this.color="white",this.thickness=5,this.processFreq=100}))}detectionLoop(){return i(this,void 0,void 0,(function*(){for(;this.continuous;){const e=this.getVideoFrame("canvas"),o=Date.now();if(e){const t=yield this.detector.detect(e);this.displayImageDetections(t)}const i=Date.now()-o;yield t.untilTimePassed(this.processFreq-i),this.clearFrame()}}))}clearFrame(){for(;this.drawables.length>0;)this.drawables.shift().destroy()}displayImageDetections(e){return i(this,void 0,void 0,(function*(){const{drawables:t,imageHelper:o}=this,i=o.createRects(e.detections,this.color,this.thickness);t.push(this.createDrawable(i))}))}setFrameRate(e){this.processFreq=1e3/e}setColor(e){this.color=t.rgbToHex(e)}setThickness(e){this.thickness=e}detectObject(e){return i(this,void 0,void 0,(function*(){const o=this.getVideoFrame("canvas"),i=yield this.detector.detect(o);this.displayImageDetections(i),yield t.untilTimePassed(1e3*e),this.clearFrame()}))}continuouslyDetectObjects(e){return i(this,void 0,void 0,(function*(){this.continuous=e,this.detectionLoop()}))}},(()=>{var i;const n="function"==typeof Symbol&&Symbol.metadata?Object.create(null!==(i=d[Symbol.metadata])&&void 0!==i?i:null):void 0;s=[t.block({type:"command",text:e=>`Set detection rate to ${e}`,arg:{type:"number",options:[60,30,10,2,1],defaultValue:10}})],a=[t.block({type:"command",text:e=>`Set box color to ${e}`,arg:"color"})],c=[t.block({type:"command",text:e=>`Set box thickness to ${e}`,arg:{type:"number",defaultValue:5,handler:e=>Math.min(Math.max(0,e),20)}})],r=[t.block({type:t.BlockType.Command,text:e=>`Detect objects for ${e} seconds`,arg:{type:t.ArgumentType.Number,defaultValue:1}})],l=[t.block({type:t.BlockType.Command,text:e=>`Toggle continuous detection ${e}`,arg:{type:t.ArgumentType.Boolean,options:[{text:"on",value:!0},{text:"off",value:!1}]}})],o(e,null,s,{kind:"method",name:"setFrameRate",static:!1,private:!1,access:{has:e=>"setFrameRate"in e,get:e=>e.setFrameRate},metadata:n},null,u),o(e,null,a,{kind:"method",name:"setColor",static:!1,private:!1,access:{has:e=>"setColor"in e,get:e=>e.setColor},metadata:n},null,u),o(e,null,c,{kind:"method",name:"setThickness",static:!1,private:!1,access:{has:e=>"setThickness"in e,get:e=>e.setThickness},metadata:n},null,u),o(e,null,r,{kind:"method",name:"detectObject",static:!1,private:!1,access:{has:e=>"detectObject"in e,get:e=>e.detectObject},metadata:n},null,u),o(e,null,l,{kind:"method",name:"continuouslyDetectObjects",static:!1,private:!1,access:{has:e=>"continuouslyDetectObjects"in e,get:e=>e.continuouslyDetectObjects},metadata:n},null,u),n&&Object.defineProperty(e,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:n})})(),e})();return e.Extension=s,Object.defineProperty(e,"__esModule",{value:!0}),e}({},ExtensionFramework);//# sourceMappingURL=objectDetection.js.map
