var chat=function(e,t){"use strict";function n(e,t,n,o,i,r){function a(e){if(void 0!==e&&"function"!=typeof e)throw new TypeError("Function expected");return e}for(var s,d=o.kind,c="getter"===d?"get":"setter"===d?"set":"value",l=e?o.static?e:e.prototype:null,u=l?Object.getOwnPropertyDescriptor(l,o.name):{},h=!1,f=n.length-1;f>=0;f--){var p={};for(var y in o)p[y]="access"===y?{}:o[y];for(var y in o.access)p.access[y]=o.access[y];p.addInitializer=function(e){if(h)throw new TypeError("Cannot add initializers after decoration has completed");r.push(a(e||null))};var g=(0,n[f])("accessor"===d?{get:u.get,set:u.set}:u[c],p);if("accessor"===d){if(void 0===g)continue;if(null===g||"object"!=typeof g)throw new TypeError("Object expected");(s=a(g.get))&&(u.get=s),(s=a(g.set))&&(u.set=s),(s=a(g.init))&&i.unshift(s)}else(s=a(g))&&("field"===d?i.unshift(s):u[c]=s)}l&&Object.defineProperty(l,o.name,u),h=!0}function o(e,t,n,o){return new(n||(n=Promise))((function(i,r){function a(e){try{d(o.next(e))}catch(e){r(e)}}function s(e){try{d(o.throw(e))}catch(e){r(e)}}function d(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}d((o=o.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;const i={name:"Chat Extension",description:"Replace me with a description of your extension",iconURL:"Replace with the name of your icon image file (which should be placed in the same directory as this file)",insetIconURL:"Replace with the name of your inset icon image file (which should be placed in the same directory as this file)"};let r=(()=>{var e;let r,a,s,d,c=t.extension(i),l=[];return e=class extends c{constructor(){super(...arguments),this.voice_id=function(e,t,n){for(var o=arguments.length>2,i=0;i<t.length;i++)n=o?t[i].call(e,n):t[i].call(e);return o?n:void 0}(this,l)}init(e){this.exampleField=0,this.voice_id=1,this.pitch_value=0}recordMicrophoneAudio(e){return o(this,void 0,void 0,(function*(){const t=yield navigator.mediaDevices.getUserMedia({audio:!0}),n=new MediaRecorder(t),o=[];n.ondataavailable=e=>{e.data.size>0&&o.push(e.data)},n.start(),yield new Promise((t=>setTimeout(t,1e3*e))),n.stop(),yield new Promise((e=>{n.onstop=()=>e()})),t.getTracks().forEach((e=>e.stop()));const i=new Blob(o,{type:"audio/webm"}),r=yield i.arrayBuffer(),a=new AudioContext,s=(yield a.decodeAudioData(r)).getChannelData(0);return new Float32Array(s)}))}saveAudioBufferToWav(e){return o(this,void 0,void 0,(function*(){function t(e,t,n){for(let o=0;o<n.length;o++)e.setUint8(t+o,n.charCodeAt(o))}const n=function(e){const n=e.numberOfChannels,o=e.sampleRate,i=16*n/8,r=o*i,a=e.length*n*2,s=new ArrayBuffer(44),d=new DataView(s);return t(d,0,"RIFF"),d.setUint32(4,36+a,!0),t(d,8,"WAVE"),t(d,12,"fmt "),d.setUint32(16,16,!0),d.setUint16(20,1,!0),d.setUint16(22,n,!0),d.setUint32(24,o,!0),d.setUint32(28,r,!0),d.setUint16(32,i,!0),d.setUint16(34,16,!0),t(d,36,"data"),d.setUint32(40,a,!0),console.log("WAV Header:",new Uint8Array(s)),s}(e),o=function(e){const t=e.numberOfChannels,n=e.length*t,o=new Float32Array(n),i=[];for(let n=0;n<t;n++)i.push(e.getChannelData(n));let r=0;for(let n=0;n<e.length;n++)for(let e=0;e<t;e++)o[r++]=i[e][n];return console.log("Interleaved data:",o),o}(e),i=new ArrayBuffer(n.byteLength+2*o.length),r=new DataView(i);return new Uint8Array(i).set(new Uint8Array(n),0),function(e,t,n){for(let o=0;o<n.length;o++,t+=2){let i=Math.max(-1,Math.min(1,n[o]));i=i<0?32768*i:32767*i,e.setInt16(t,i,!0)}}(r,n.byteLength,o),console.log("Final WAV buffer length:",i.byteLength),console.log("Expected data length:",n.byteLength+2*o.length),new Blob([i],{type:"audio/wav"})}))}writeString(e,t,n){for(let o=0;o<n.length;o++)e.setUint8(t+o,n.charCodeAt(o))}generateWAV(e,t){const n=1*t*2,o=2*e.length,i=44+o,r=new ArrayBuffer(i),a=new DataView(r);this.writeString(a,0,"RIFF"),a.setUint32(4,i-8,!0),this.writeString(a,8,"WAVE"),this.writeString(a,12,"fmt "),a.setUint32(16,16,!0),a.setUint16(20,1,!0),a.setUint16(22,1,!0),a.setUint32(24,t,!0),a.setUint32(28,n,!0),a.setUint16(32,2,!0),a.setUint16(34,16,!0),this.writeString(a,36,"data"),a.setUint32(40,o,!0);for(let t=0;t<e.length;t++){const n=Math.max(-1,Math.min(1,e[t]));a.setInt16(44+2*t,n<0?32768*n:32767*n,!0)}return new Uint8Array(r)}createAndSaveWAV(e,t){const n=this.generateWAV(e,t),o=new Blob([n],{type:"audio/wav"}),i=URL.createObjectURL(o),r=document.createElement("a");return r.href=i,r.download="output.wav",document.body.appendChild(r),r.click(),document.body.removeChild(r),o}blobToBase64(e){return new Promise(((t,n)=>{const o=new FileReader;o.onloadend=()=>t(o.result),o.onerror=n,o.readAsDataURL(e)}))}getListenEndpoint(e){return o(this,void 0,void 0,(function*(){console.log("sending audio file");const t=new FormData;t.append("audio_file",e);try{let e;if(e=yield fetch("https://doodlebot.media.mit.edu/listen",{method:"POST",body:t}),!e.ok){const t=yield e.text();throw console.log("Error response:",t),new Error(`HTTP error! status: ${e.status}`)}const n=yield e.json();return n.text}catch(e){return console.error("Error sending audio file:",e),"Error"}}))}sendAudioFileToChatEndpoint(e,t,n,i){return o(this,void 0,void 0,(function*(){console.log("sending audio file");const n=`https://doodlebot.media.mit.edu/${t}?voice=${this.voice_id}&pitch=${this.pitch_value}`,o=new FormData;o.append("audio_file",e);const i=URL.createObjectURL(e);new Audio(i);try{let e;if(e=yield fetch(n,{method:"POST",body:o}),!e.ok){const t=yield e.text();throw console.log("Error response:",t),new Error(`HTTP error! status: ${e.status}`)}if("listen"==t){const t=yield e.json();return t.text}const i=e.headers.get("text-response");console.log("Text Response:",i);const r=yield e.blob(),a=URL.createObjectURL(r);console.log("Audio URL:",a);new Audio(a).play()}catch(e){console.error("Error sending audio file:",e)}}))}isValidWavFile(e){return o(this,void 0,void 0,(function*(){const t=yield e.arrayBuffer();if("RIFF"!==String.fromCharCode(...new Uint8Array(t.slice(0,4))))return console.error("Invalid WAV file: Missing RIFF header"),!1;if("WAVE"!==String.fromCharCode(...new Uint8Array(t.slice(8,12))))return console.error("Invalid WAV file: Missing WAVE format"),!1;if("fmt "!==String.fromCharCode(...new Uint8Array(t.slice(12,16))))return console.error("Invalid WAV file: Missing fmt subchunk"),!1;const n=t.byteLength-8;return"data"!==String.fromCharCode(...new Uint8Array(t.slice(n,n+4)))?(console.error("Invalid WAV file: Missing data subchunk"),!1):(console.log("Valid WAV file"),!0)}))}processAndSendAudio(e,t,n){return o(this,void 0,void 0,(function*(){try{const o=new AudioContext,i=o.createBuffer(1,e.length,o.sampleRate);i.copyToChannel(e,0);const r=yield this.saveAudioBufferToWav(i),a=new File([r],"output.wav",{type:"audio/wav"});yield this.sendAudioFileToChatEndpoint(a,t,r,n)}catch(e){console.error("Error processing and sending audio:",e)}}))}processAndSendAudioListen(e){return o(this,void 0,void 0,(function*(){try{const t=new AudioContext,n=t.createBuffer(1,e.length,t.sampleRate);n.copyToChannel(e,0);const o=yield this.saveAudioBufferToWav(n),i=new File([o],"output.wav",{type:"audio/wav"});return yield this.getListenEndpoint(i)}catch(e){return console.error("Error processing and sending audio:",e),"Error"}}))}handleChatInteraction(e,t){return o(this,void 0,void 0,(function*(){console.log(`recording audio for ${e} seconds`),console.log("recording audio?");const n=yield this.recordMicrophoneAudio(e);console.log("finished recording audio"),yield this.processAndSendAudio(n,t,e)}))}handleReturnListenInteraction(e){return o(this,void 0,void 0,(function*(){console.log(`recording audio for ${e} seconds`),console.log("recording audio?");const t=yield this.recordMicrophoneAudio(e);return console.log("finished recording audio"),yield this.processAndSendAudioListen(t)}))}handleReturnChatInteraction(e){return o(this,void 0,void 0,(function*(){try{let t;if(t=yield fetch("https://doodlebot.media.mit.edu/prompt",{method:"POST",body:JSON.stringify({text_input:e})}),!t.ok){const e=yield t.text();throw console.log("Error response:",e),new Error(`HTTP error! status: ${t.status}`)}const n=yield t.json();return n.text}catch(e){return console.error("Error sending audio file:",e),"Error"}}))}speakText(e){return o(this,arguments,void 0,(function*(e,t=!1){try{const t=`https://doodlebot.media.mit.edu/speak?voice=${this.voice_id}&pitch=${this.pitch_value}`,n=yield fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e})});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const o=yield n.blob(),i=URL.createObjectURL(o),r=new Audio(i);yield new Promise((e=>{r.addEventListener("loadedmetadata",(()=>e()))})),r.play(),yield new Promise((e=>{r.addEventListener("ended",(()=>e())),r.addEventListener("error",(()=>e()))})),console.log("âœ… Audio playback finished")}catch(e){throw console.error("Error in speakText function:",e),e}}))}promptChatAPI(e){return o(this,void 0,void 0,(function*(){return yield this.handleReturnChatInteraction(e)}))}testRepeatAPI(e){return o(this,void 0,void 0,(function*(){return yield this.handleReturnListenInteraction(e)}))}speak(e,t){return o(this,void 0,void 0,(function*(){yield this.speakText(e)}))}setVoiceAndPitch(e,t){return o(this,void 0,void 0,(function*(){this.voice_id=e,this.pitch_value=t}))}},(()=>{var o;const i="function"==typeof Symbol&&Symbol.metadata?Object.create(null!==(o=c[Symbol.metadata])&&void 0!==o?o:null):void 0;r=[t.block({type:"reporter",text:e=>`prompt ${e}`,arg:{type:"string",defaultValue:"What is your favorite color?"}})],a=[t.block({type:"reporter",text:e=>`listen for ${e} seconds`,arg:{type:"number",defaultValue:3}})],s=[t.block({type:"command",text:e=>`say ${e}`,arg:{type:"string",defaultValue:"Hello!"}})],d=[t.block({type:"command",text:(e,t)=>`set voice to ${e} and pitch to ${t}`,args:[{type:"number",defaultValue:1},{type:"number",defaultValue:0}]})],n(e,0,r,{kind:"method",name:"promptChatAPI",static:!1,private:!1,access:{has:e=>"promptChatAPI"in e,get:e=>e.promptChatAPI},metadata:i},null,l),n(e,0,a,{kind:"method",name:"testRepeatAPI",static:!1,private:!1,access:{has:e=>"testRepeatAPI"in e,get:e=>e.testRepeatAPI},metadata:i},null,l),n(e,0,s,{kind:"method",name:"speak",static:!1,private:!1,access:{has:e=>"speak"in e,get:e=>e.speak},metadata:i},null,l),n(e,0,d,{kind:"method",name:"setVoiceAndPitch",static:!1,private:!1,access:{has:e=>"setVoiceAndPitch"in e,get:e=>e.setVoiceAndPitch},metadata:i},null,l),i&&Object.defineProperty(e,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:i})})(),e})();return e.Extension=r,e}({},ExtensionFramework);//# sourceMappingURL=chat.js.map
