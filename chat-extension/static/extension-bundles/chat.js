var chat=function(e,t){"use strict";function n(e,t,n,i,o,r){function a(e){if(void 0!==e&&"function"!=typeof e)throw new TypeError("Function expected");return e}for(var s,c=i.kind,d="getter"===c?"get":"setter"===c?"set":"value",l=e?i.static?e:e.prototype:null,u=l?Object.getOwnPropertyDescriptor(l,i.name):{},h=!1,f=n.length-1;f>=0;f--){var p={};for(var y in i)p[y]="access"===y?{}:i[y];for(var y in i.access)p.access[y]=i.access[y];p.addInitializer=function(e){if(h)throw new TypeError("Cannot add initializers after decoration has completed");r.push(a(e||null))};var m=(0,n[f])("accessor"===c?{get:u.get,set:u.set}:u[d],p);if("accessor"===c){if(void 0===m)continue;if(null===m||"object"!=typeof m)throw new TypeError("Object expected");(s=a(m.get))&&(u.get=s),(s=a(m.set))&&(u.set=s),(s=a(m.init))&&o.unshift(s)}else(s=a(m))&&("field"===c?o.unshift(s):u[d]=s)}l&&Object.defineProperty(l,i.name,u),h=!0}function i(e,t,n,i){return new(n||(n=Promise))((function(o,r){function a(e){try{c(i.next(e))}catch(e){r(e)}}function s(e){try{c(i.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((i=i.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;const o={name:"Chat Extension",description:"Replace me with a description of your extension",iconURL:"Replace with the name of your icon image file (which should be placed in the same directory as this file)",insetIconURL:"Replace with the name of your inset icon image file (which should be placed in the same directory as this file)"};let r=(()=>{var e;let r,a,s,c,d=t.extension(o),l=[];return e=class extends d{constructor(){super(...arguments),this.voice_id=function(e,t,n){for(var i=arguments.length>2,o=0;o<t.length;o++)n=i?t[o].call(e,n):t[o].call(e);return i?n:void 0}(this,l)}init(e){this.exampleField=0,this.voice_id=1,this.pitch_value=0}recordMicrophoneAudio(e){return i(this,void 0,void 0,(function*(){const t=yield navigator.mediaDevices.getUserMedia({audio:!0}),n=new MediaRecorder(t),i=[];n.ondataavailable=e=>{e.data.size>0&&i.push(e.data)},n.start(),yield new Promise((t=>setTimeout(t,1e3*e))),n.stop(),yield new Promise((e=>{n.onstop=()=>e()})),t.getTracks().forEach((e=>e.stop()));const o=new Blob(i,{type:"audio/webm"}),r=yield o.arrayBuffer(),a=new AudioContext,s=(yield a.decodeAudioData(r)).getChannelData(0);return new Float32Array(s)}))}saveAudioBufferToWav(e){return i(this,void 0,void 0,(function*(){function t(e,t,n){for(let i=0;i<n.length;i++)e.setUint8(t+i,n.charCodeAt(i))}const n=function(e){const n=e.numberOfChannels,i=e.sampleRate,o=16*n/8,r=i*o,a=e.length*n*2,s=new ArrayBuffer(44),c=new DataView(s);return t(c,0,"RIFF"),c.setUint32(4,36+a,!0),t(c,8,"WAVE"),t(c,12,"fmt "),c.setUint32(16,16,!0),c.setUint16(20,1,!0),c.setUint16(22,n,!0),c.setUint32(24,i,!0),c.setUint32(28,r,!0),c.setUint16(32,o,!0),c.setUint16(34,16,!0),t(c,36,"data"),c.setUint32(40,a,!0),console.log("WAV Header:",new Uint8Array(s)),s}(e),i=function(e){const t=e.numberOfChannels,n=e.length*t,i=new Float32Array(n),o=[];for(let n=0;n<t;n++)o.push(e.getChannelData(n));let r=0;for(let n=0;n<e.length;n++)for(let e=0;e<t;e++)i[r++]=o[e][n];return console.log("Interleaved data:",i),i}(e),o=new ArrayBuffer(n.byteLength+2*i.length),r=new DataView(o);return new Uint8Array(o).set(new Uint8Array(n),0),function(e,t,n){for(let i=0;i<n.length;i++,t+=2){let o=Math.max(-1,Math.min(1,n[i]));o=o<0?32768*o:32767*o,e.setInt16(t,o,!0)}}(r,n.byteLength,i),console.log("Final WAV buffer length:",o.byteLength),console.log("Expected data length:",n.byteLength+2*i.length),new Blob([o],{type:"audio/wav"})}))}writeString(e,t,n){for(let i=0;i<n.length;i++)e.setUint8(t+i,n.charCodeAt(i))}generateWAV(e,t){const n=1*t*2,i=2*e.length,o=44+i,r=new ArrayBuffer(o),a=new DataView(r);this.writeString(a,0,"RIFF"),a.setUint32(4,o-8,!0),this.writeString(a,8,"WAVE"),this.writeString(a,12,"fmt "),a.setUint32(16,16,!0),a.setUint16(20,1,!0),a.setUint16(22,1,!0),a.setUint32(24,t,!0),a.setUint32(28,n,!0),a.setUint16(32,2,!0),a.setUint16(34,16,!0),this.writeString(a,36,"data"),a.setUint32(40,i,!0);for(let t=0;t<e.length;t++){const n=Math.max(-1,Math.min(1,e[t]));a.setInt16(44+2*t,n<0?32768*n:32767*n,!0)}return new Uint8Array(r)}createAndSaveWAV(e,t){const n=this.generateWAV(e,t),i=new Blob([n],{type:"audio/wav"}),o=URL.createObjectURL(i),r=document.createElement("a");return r.href=o,r.download="output.wav",document.body.appendChild(r),r.click(),document.body.removeChild(r),i}blobToBase64(e){return new Promise(((t,n)=>{const i=new FileReader;i.onloadend=()=>t(i.result),i.onerror=n,i.readAsDataURL(e)}))}sendAudioFileToChatEndpoint(e,t,n,o){return i(this,void 0,void 0,(function*(){console.log("sending audio file");const n=`https://doodlebot.media.mit.edu/${t}?voice=${this.voice_id}&pitch=${this.pitch_value}`,i=new FormData;i.append("audio_file",e);const o=URL.createObjectURL(e);new Audio(o);try{let e;if(e=yield fetch(n,{method:"POST",body:i}),!e.ok){const t=yield e.text();throw console.log("Error response:",t),new Error(`HTTP error! status: ${e.status}`)}const t=e.headers.get("text-response");console.log("Text Response:",t);const o=yield e.blob(),r=URL.createObjectURL(o);console.log("Audio URL:",r);new Audio(r).play()}catch(e){console.error("Error sending audio file:",e)}}))}isValidWavFile(e){return i(this,void 0,void 0,(function*(){const t=yield e.arrayBuffer();if("RIFF"!==String.fromCharCode(...new Uint8Array(t.slice(0,4))))return console.error("Invalid WAV file: Missing RIFF header"),!1;if("WAVE"!==String.fromCharCode(...new Uint8Array(t.slice(8,12))))return console.error("Invalid WAV file: Missing WAVE format"),!1;if("fmt "!==String.fromCharCode(...new Uint8Array(t.slice(12,16))))return console.error("Invalid WAV file: Missing fmt subchunk"),!1;const n=t.byteLength-8;return"data"!==String.fromCharCode(...new Uint8Array(t.slice(n,n+4)))?(console.error("Invalid WAV file: Missing data subchunk"),!1):(console.log("Valid WAV file"),!0)}))}processAndSendAudio(e,t,n){return i(this,void 0,void 0,(function*(){try{const i=new AudioContext,o=i.createBuffer(1,e.length,i.sampleRate);o.copyToChannel(e,0);const r=yield this.saveAudioBufferToWav(o),a=new File([r],"output.wav",{type:"audio/wav"});yield this.sendAudioFileToChatEndpoint(a,t,r,n)}catch(e){console.error("Error processing and sending audio:",e)}}))}handleChatInteraction(e,t){return i(this,void 0,void 0,(function*(){console.log(`recording audio for ${e} seconds`),console.log("recording audio?");const n=yield this.recordMicrophoneAudio(e);console.log("finished recording audio"),yield this.processAndSendAudio(n,t,e)}))}speakText(e){return i(this,arguments,void 0,(function*(e,t=!1){try{const t=`https://doodlebot.media.mit.edu/speak?voice=${this.voice_id}&pitch=${this.pitch_value}`,n=yield fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e})});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const i=yield n.blob(),o=URL.createObjectURL(i),r=new Audio(o);yield new Promise((e=>{r.addEventListener("loadedmetadata",(()=>{e(null)}))})),r.play()}catch(e){throw console.error("Error in speak function:",e),e}}))}testChatAPI(e){return i(this,void 0,void 0,(function*(){yield this.handleChatInteraction(e,"chat")}))}testRepeatAPI(e){return i(this,void 0,void 0,(function*(){yield this.handleChatInteraction(e,"repeat_after_me")}))}speak(e,t){return i(this,void 0,void 0,(function*(){yield this.speakText(e)}))}setVoiceAndPitch(e,t){return i(this,void 0,void 0,(function*(){this.voice_id=e,this.pitch_value=t}))}},(()=>{var i;const o="function"==typeof Symbol&&Symbol.metadata?Object.create(null!==(i=d[Symbol.metadata])&&void 0!==i?i:null):void 0;r=[t.block({type:"command",text:e=>`chat for ${e} seconds`,arg:{type:"number",defaultValue:3}})],a=[t.block({type:"command",text:e=>`repeat after me for ${e} seconds`,arg:{type:"number",defaultValue:3}})],s=[t.block({type:"command",text:e=>`say ${e}`,arg:{type:"string",defaultValue:"Hello!"}})],c=[t.block({type:"command",text:(e,t)=>`set voice to ${e} and pitch to ${t}`,args:[{type:"number",defaultValue:1},{type:"number",defaultValue:0}]})],n(e,0,r,{kind:"method",name:"testChatAPI",static:!1,private:!1,access:{has:e=>"testChatAPI"in e,get:e=>e.testChatAPI},metadata:o},null,l),n(e,0,a,{kind:"method",name:"testRepeatAPI",static:!1,private:!1,access:{has:e=>"testRepeatAPI"in e,get:e=>e.testRepeatAPI},metadata:o},null,l),n(e,0,s,{kind:"method",name:"speak",static:!1,private:!1,access:{has:e=>"speak"in e,get:e=>e.speak},metadata:o},null,l),n(e,0,c,{kind:"method",name:"setVoiceAndPitch",static:!1,private:!1,access:{has:e=>"setVoiceAndPitch"in e,get:e=>e.setVoiceAndPitch},metadata:o},null,l),o&&Object.defineProperty(e,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:o})})(),e})();return e.Extension=r,e}({},ExtensionFramework);//# sourceMappingURL=chat.js.map
