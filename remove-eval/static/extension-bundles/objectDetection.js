var objectDetection=function(e,t){"use strict";function o(e,t,o,n,i,s){function c(e){if(void 0!==e&&"function"!=typeof e)throw new TypeError("Function expected");return e}for(var a,r=n.kind,l="getter"===r?"get":"setter"===r?"set":"value",d=!t&&e?n.static?e:e.prototype:null,u=t||(d?Object.getOwnPropertyDescriptor(d,n.name):{}),h=!1,p=o.length-1;p>=0;p--){var m={};for(var f in n)m[f]="access"===f?{}:n[f];for(var f in n.access)m.access[f]=n.access[f];m.addInitializer=function(e){if(h)throw new TypeError("Cannot add initializers after decoration has completed");s.push(c(e||null))};var g=(0,o[p])("accessor"===r?{get:u.get,set:u.set}:u[l],m);if("accessor"===r){if(void 0===g)continue;if(null===g||"object"!=typeof g)throw new TypeError("Object expected");(a=c(g.get))&&(u.get=a),(a=c(g.set))&&(u.set=a),(a=c(g.init))&&i.unshift(a)}else(a=c(g))&&("field"===r?i.unshift(a):u[l]=a)}d&&Object.defineProperty(d,n.name,u),h=!0}function n(e,t,o,n){return new(o||(o=Promise))((function(i,s){function c(e){try{r(n.next(e))}catch(e){s(e)}}function a(e){try{r(n.throw(e))}catch(e){s(e)}}function r(e){var t;e.done?i(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(c,a)}r((n=n.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;const i={name:"Object Detection",description:"Detects and identifies the object shown!",iconURL:"Typescript_logo.png",insetIconURL:"typescript-logo.svg",tags:["PRG Internal"]};let s=(()=>{var e;let s,c,a,r,l,d=t.extension(i,"video","drawable","addCostumes","toggleVideoBlock","setTransparencyBlock"),u=[];return e=class extends d{constructor(){super(...arguments),this.detector=void function(e,t,o){for(var n=arguments.length>2,i=0;i<t.length;i++)o=n?t[i].call(e,o):t[i].call(e)}(this,u),this.DIMENSIONS=[480,360],this.drawables=[]}init(){return n(this,void 0,void 0,(function*(){this.enableVideo(),this.continuous=!1,this.detector=yield n(void 0,void 0,void 0,(function*(){const{ObjectDetector:e,FilesetResolver:t}=yield import("https://cdn.skypack.dev/@mediapipe/tasks-vision@0.1.0-alpha-11"),o=yield t.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.1.0-alpha-11/wasm");return yield e.createFromOptions(o,{baseOptions:{modelAssetPath:"https://storage.googleapis.com/mediapipe-tasks/object_detector/efficientdet_lite0_uint8.tflite"},scoreThreshold:.5,runningMode:"IMAGE"})})),this.imageHelper=((e,t)=>{const o=document.body.appendChild(document.createElement("canvas"));o.hidden=!0,o.width=e,o.height=t;const n=o.getContext("2d");return{createRects(o,i,s){n.save(),n.clearRect(0,0,e,t),n.fillStyle=i;for(let e of o){const t=e.boundingBox.originX,o=e.boundingBox.originY,i=e.boundingBox.width,c=e.boundingBox.height;n.fillRect(t,o,i,c),n.clearRect(t+s,o+s,i-2*s,c-2*s);const a=e.categories[0].categoryName+" - with "+Math.round(100*parseFloat(e.categories[0].score))+"% confidence.";n.fillText(a,t,o-5)}return n.restore(),n.getImageData(0,0,e,t)}}})(this.DIMENSIONS[0],this.DIMENSIONS[1]),this.color="white",this.thickness=5,this.processFreq=100}))}detectionLoop(){return n(this,void 0,void 0,(function*(){for(;this.continuous;){const e=this.getVideoFrame("canvas"),o=Date.now();if(e){const t=yield this.detector.detect(e);this.displayImageDetections(t)}const n=Date.now()-o;yield t.untilTimePassed(this.processFreq-n),this.clearFrame()}}))}clearFrame(){for(;this.drawables.length>0;)this.drawables.shift().destroy()}displayImageDetections(e){return n(this,void 0,void 0,(function*(){const{drawables:t,imageHelper:o}=this,n=o.createRects(e.detections,this.color,this.thickness);t.push(this.createDrawable(n))}))}setFrameRate(e){this.processFreq=1e3/e}setColor(e){this.color=t.rgbToHex(e)}setThickness(e){this.thickness=e}detectObject(e){return n(this,void 0,void 0,(function*(){const o=this.getVideoFrame("canvas"),n=yield this.detector.detect(o);this.displayImageDetections(n),yield t.untilTimePassed(1e3*e),this.clearFrame()}))}continuouslyDetectObjects(e){return n(this,void 0,void 0,(function*(){this.continuous=e,this.detectionLoop()}))}},(()=>{var n;const i="function"==typeof Symbol&&Symbol.metadata?Object.create(null!==(n=d[Symbol.metadata])&&void 0!==n?n:null):void 0;s=[t.block({type:"command",text:e=>`Set detection rate to ${e}`,arg:{type:"number",options:[60,30,10,2,1],defaultValue:10}})],c=[t.block({type:"command",text:e=>`Set box color to ${e}`,arg:"color"})],a=[t.block({type:"command",text:e=>`Set box thickness to ${e}`,arg:{type:"number",defaultValue:5}})],r=[t.block({type:t.BlockType.Command,text:e=>`Detect objects for ${e} seconds`,arg:{type:t.ArgumentType.Number,defaultValue:1}})],l=[t.block({type:t.BlockType.Command,text:e=>`Toggle continuous detection ${e}`,arg:{type:t.ArgumentType.Boolean,options:[{text:"on",value:!0},{text:"off",value:!1}]}})],o(e,null,s,{kind:"method",name:"setFrameRate",static:!1,private:!1,access:{has:e=>"setFrameRate"in e,get:e=>e.setFrameRate},metadata:i},null,u),o(e,null,c,{kind:"method",name:"setColor",static:!1,private:!1,access:{has:e=>"setColor"in e,get:e=>e.setColor},metadata:i},null,u),o(e,null,a,{kind:"method",name:"setThickness",static:!1,private:!1,access:{has:e=>"setThickness"in e,get:e=>e.setThickness},metadata:i},null,u),o(e,null,r,{kind:"method",name:"detectObject",static:!1,private:!1,access:{has:e=>"detectObject"in e,get:e=>e.detectObject},metadata:i},null,u),o(e,null,l,{kind:"method",name:"continuouslyDetectObjects",static:!1,private:!1,access:{has:e=>"continuouslyDetectObjects"in e,get:e=>e.continuouslyDetectObjects},metadata:i},null,u),i&&Object.defineProperty(e,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:i})})(),e})();return e.Extension=s,Object.defineProperty(e,"__esModule",{value:!0}),e}({},ExtensionFramework);//# sourceMappingURL=objectDetection.js.map
