var poseFace=function(e,t){"use strict";function o(e,t,o,i){return new(o||(o=Promise))((function(n,a){function s(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,r)}l((i=i.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;const i={id:"poseFace",name:"Face Sensing",showStatusButton:!0,blocks:[{opcode:"affdexGoToPart",text:"go to [AFFDEX_POINT]",blockType:"command",isTerminal:!1,arguments:{AFFDEX_POINT:{type:"string",defaultValue:"0",menu:"AFFDEX_POINT"}}},{opcode:"affdexWhenExpression",text:"when [EXPRESSION] detected",blockType:"hat",isTerminal:!0,arguments:{EXPRESSION:{type:"string",defaultValue:"smile",menu:"EXPRESSION"}}},{opcode:"affdexExpressionAmount",text:"amount of [EXPRESSION]",blockType:"reporter",isTerminal:!0,arguments:{EXPRESSION:{type:"string",defaultValue:"smile",menu:"EXPRESSION"}}},{opcode:"affdexIsExpression",text:"expressing [EXPRESSION]",blockType:"Boolean",isTerminal:!0,arguments:{EXPRESSION:{type:"string",defaultValue:"smile",menu:"EXPRESSION"}}},{opcode:"affdexWhenEmotion",text:"when [EMOTION] feeling detected",blockType:"hat",isTerminal:!0,arguments:{EMOTION:{type:"string",defaultValue:"joy",menu:"EMOTION"}}},{opcode:"affdexEmotionAmount",text:"level of [EMOTION_ALL]",blockType:"reporter",isTerminal:!0,arguments:{EMOTION_ALL:{type:"string",defaultValue:"joy",menu:"EMOTION_ALL"}}},{opcode:"affdexIsTopEmotion",text:"feeling [EMOTION]",blockType:"Boolean",isTerminal:!0,arguments:{EMOTION:{type:"string",defaultValue:"joy",menu:"EMOTION"}}},{opcode:"videoToggle",text:"turn video [VIDEO_STATE]",arguments:{VIDEO_STATE:{type:"string",menu:"VIDEO_STATE",defaultValue:"off"}},blockType:"command"},{opcode:"setVideoTransparency",text:"set video transparency to [TRANSPARENCY]",arguments:{TRANSPARENCY:{type:"number",defaultValue:50}},blockType:"command"}],menus:{AFFDEX_POINT:{items:[{text:"left ear",value:"0"},{text:"left chin",value:"1"},{text:"chin",value:"2"},{text:"right chin",value:"3"},{text:"right ear",value:"4"},{text:"left outer eyebrow",value:"5"},{text:"left eyebrow",value:"6"},{text:"left inner eyebrow",value:"7"},{text:"right inner eyebrow",value:"8"},{text:"right eyebrow",value:"9"},{text:"right outer eyebrow",value:"10"},{text:"nose bridge",value:"11"},{text:"nose tip",value:"12"},{text:"left nostril",value:"13"},{text:"nose tip",value:"14"},{text:"right nostril",value:"15"},{text:"left outer eye crease",value:"16"},{text:"left inner eye crease",value:"17"},{text:"right inner eye crease",value:"18"},{text:"right outer eye crease",value:"19"},{text:"left mouth crease",value:"20"},{text:"left upper lip point",value:"21"},{text:"upper lip",value:"22"},{text:"right upper lip point",value:"23"},{text:"right mouth crease",value:"24"},{text:"right lower lip point",value:"25"},{text:"lower lip",value:"26"},{text:"left lower lip point",value:"27"},{text:"upper lip bottom",value:"28"},{text:"lower lip top",value:"29"},{text:"left upper eyelid",value:"30"},{text:"left lower eyelid",value:"31"},{text:"right upper eyelid",value:"32"},{text:"right lower eyelid",value:"33"}],acceptReporters:!1},EMOTION:{acceptReporters:!0,items:[{text:"joyful",value:"joy"},{text:"sad",value:"sadness"},{text:"disgusted",value:"disgust"},{text:"angry",value:"anger"},{text:"fearful",value:"fear"}]},EXPRESSION:{acceptReporters:!0,items:[{text:"smile",value:"smile"},{text:"mouth open",value:"mouthOpen"},{text:"eye closure",value:"eyeClosure"},{text:"eyebrow raise",value:"browRaise"},{text:"whistling",value:"lipPucker"},{text:"eye widening",value:"eyeWiden"},{text:"eyebrow furrow",value:"browFurrow"},{text:"nose wrinkle",value:"noseWrinkle"},{text:"upper lip raise",value:"upperLipRaise"},{text:"lip corner pull",value:"lipCornerDepressor"},{text:"chin raise",value:"chinRaise"},{text:"smirk",value:"smirk"},{text:"attention",value:"attention"},{text:"eyelid tighten",value:"lidTighten"},{text:"jaw drop",value:"jawDrop"},{text:"cheek dimple",value:"dimpler"},{text:"cheek raise",value:"cheekRaise"},{text:"lip stretch",value:"lipStretch"}]},EMOTION_ALL:{acceptReporters:!0,items:[{text:"joy",value:"joy"},{text:"sadness",value:"sadness"},{text:"disgust",value:"disgust"},{text:"contempt",value:"contempt"},{text:"anger",value:"anger"},{text:"fear",value:"fear"},{text:"surprise",value:"surprise"},{text:"valence",value:"valence"},{text:"engagement",value:"engagement"}]},ATTRIBUTE:{acceptReporters:!0,items:[{text:"motion",value:"motion"},{text:"direction",value:"direction"}]},SUBJECT:{acceptReporters:!0,items:[{text:"sprite",value:"this sprite"},{text:"stage",value:"Stage"}]},VIDEO_STATE:{acceptReporters:!0,items:[{text:"off",value:"off"},{text:"on",value:"on"},{text:"on flipped",value:"on-flipped"}]}}},n=t.legacy(i);t.legacy(i,{incrementalDevelopment:!0});const{legacyExtension:a,legacyDefinition:s}=n.for(),r="off",l="on";function u(e){return parseFloat(Number(e).toFixed(2))}let d=(()=>{let e,n,d=[a(),t.validGenericExtension()],c=[],f=t.Extension;var p,x;return n=class extends f{constructor(){super(...arguments),this.INTERVAL=33,this.DIMENSIONS=[480,360],this.expressions=i.menus.EXPRESSION.items,this.emotions=i.menus.EMOTION.items,this.all_emotions=i.menus.EMOTION_ALL.items}init(e){this.runtime.ioDevices&&(this.runtime.on(t.RuntimeEvent.ProjectStart,this.projectStarted.bind(this)),this._loop())}projectStarted(){this.setTransparency(this.globalVideoTransparency),this.toggleVideo(this.globalVideoState)}convertCoordsToScratch({x:e,y:t}){return{x:e-this.DIMENSIONS[0]/2,y:this.DIMENSIONS[1]/2-t}}_loop(){return o(this,void 0,void 0,(function*(){for(;;){const e=this.runtime.ioDevices.video.getFrame({format:"image-data",dimensions:this.DIMENSIONS}),t=+new Date;e&&(this.affdexState=yield this.estimateAffdexOnImage(e));const o=(+new Date-t)/4;yield new Promise((e=>setTimeout(e,o)))}}))}estimateAffdexOnImage(e){return o(this,void 0,void 0,(function*(){const t=yield this.ensureAffdexLoaded(e);return t.process(e,0),new Promise(((e,o)=>{const i=function(o,n,a){t.removeEventListener("onImageResultsSuccess",i),o.length<1?e(null):e(o[0])};t.addEventListener("onImageResultsSuccess",i)}))}))}ensureAffdexLoaded(e){return o(this,void 0,void 0,(function*(){if(this.affdexDetector)return this.affdexDetector;const o=yield t.untilExternalGlobalVariableLoaded("https://download.affectiva.com/js/3.2.1/affdex.js","affdex"),i=new Promise(((t,i)=>{const n=this.DIMENSIONS[0],a=this.DIMENSIONS[1],s=o.FaceDetectorMode.LARGE_FACES,r=new o.PhotoDetector(e,n,a,s);r.detectAllEmotions(),r.detectAllExpressions(),r.start(),this.affdexDetector=r,r.addEventListener("onInitializeSuccess",t)}));return yield i,this.affdexDetector}))}goToPart(e,t){if(!this.affdexState||!this.affdexState.featurePoints)return;const o=this.affdexState.featurePoints[e],{x:i,y:n}=this.convertCoordsToScratch(o);t.target.setXY(i,n,!1)}isExpression(e){return!(!this.affdexState||!this.affdexState.expressions)&&this.affdexState.expressions[e]>.5}expressionAmount(e){return this.affdexState&&this.affdexState.expressions?u(this.affdexState.expressions[e]):0}isTopEmotion(e,t){if(!this.affdexState||!this.affdexState.emotions)return!1;let o=-Number.MAX_VALUE,i=null;return t.forEach((e=>{const t=this.affdexState.emotions[e.value];t>o&&(o=t,i=e)})),e==i.value}emotionAmount(e){return this.affdexState&&this.affdexState.emotions?u(this.affdexState.emotions[e]):0}toggleVideo(e){if(e===r)return this.runtime.ioDevices.video.disableVideo();this.runtime.ioDevices.video.enableVideo(),this.runtime.ioDevices.video.mirror=e===l}setTransparency(e){const t=Math.max(Math.min(e,100),0);this.runtime.ioDevices.video.setPreviewGhost(t)}defineBlocks(){this.globalVideoState=l,this.globalVideoTransparency=50,this.projectStarted();const e=this.expressions.map((e=>e.value)),t=this.emotions.map((e=>e.value)),o=this.all_emotions.map((e=>e.value));return{affdexGoToPart:s.affdexGoToPart({operation:(e,t)=>{this.goToPart(e,t)}}),affdexWhenExpression:s.affdexWhenExpression({operation:e=>this.isExpression(e),argumentMethods:{0:{handler:t=>e.includes(t)?t:"smile"}}}),affdexExpressionAmount:s.affdexExpressionAmount({operation:e=>this.expressionAmount(e),argumentMethods:{0:{handler:t=>e.includes(t)?t:"smile"}}}),affdexIsExpression:s.affdexIsExpression({operation:e=>this.isExpression(e),argumentMethods:{0:{handler:t=>e.includes(t)?t:"smile"}}}),affdexWhenEmotion:s.affdexWhenEmotion({operation:e=>this.isTopEmotion(e,this.emotions),argumentMethods:{0:{handler:e=>t.includes(e)?e:"joy"}}}),affdexEmotionAmount:s.affdexEmotionAmount({operation:e=>this.emotionAmount(e),argumentMethods:{0:{handler:e=>o.includes(e)?e:"joy"}}}),affdexIsTopEmotion:s.affdexIsTopEmotion({operation:e=>this.isTopEmotion(e,this.emotions),argumentMethods:{0:{handler:e=>t.includes(e)?e:"joy"}}}),videoToggle:s.videoToggle({operation:e=>{this.toggleVideo(e)},argumentMethods:{0:{handler:e=>["on","off","on-flipped"].includes(e)?e:l}}}),setVideoTransparency:s.setVideoTransparency({operation:e=>{this.setTransparency(e)}})}}},p=n,x="PoseFace",Object.defineProperty(p,"name",{configurable:!0,value:x}),(()=>{var t;const o="function"==typeof Symbol&&Symbol.metadata?Object.create(null!==(t=f[Symbol.metadata])&&void 0!==t?t:null):void 0;!function(e,t,o,i,n,a){function s(e){if(void 0!==e&&"function"!=typeof e)throw new TypeError("Function expected");return e}for(var r,l=i.kind,u="getter"===l?"get":"setter"===l?"set":"value",d=!t&&e?i.static?e:e.prototype:null,c=t||(d?Object.getOwnPropertyDescriptor(d,i.name):{}),f=!1,p=o.length-1;p>=0;p--){var x={};for(var m in i)x[m]="access"===m?{}:i[m];for(var m in i.access)x.access[m]=i.access[m];x.addInitializer=function(e){if(f)throw new TypeError("Cannot add initializers after decoration has completed");a.push(s(e||null))};var h=(0,o[p])("accessor"===l?{get:c.get,set:c.set}:c[u],x);if("accessor"===l){if(void 0===h)continue;if(null===h||"object"!=typeof h)throw new TypeError("Object expected");(r=s(h.get))&&(c.get=r),(r=s(h.set))&&(c.set=r),(r=s(h.init))&&n.unshift(r)}else(r=s(h))&&("field"===l?n.unshift(r):c[u]=r)}d&&Object.defineProperty(d,i.name,c),f=!0}(null,e={value:n},d,{kind:"class",name:n.name,metadata:o},null,c),n=e.value,o&&Object.defineProperty(n,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:o}),function(e,t,o){for(var i=arguments.length>2,n=0;n<t.length;n++)o=i?t[n].call(e,o):t[n].call(e)}(n,c)})(),n})();return e.Extension=d,e}({},ExtensionFramework);//# sourceMappingURL=poseFace.js.map
